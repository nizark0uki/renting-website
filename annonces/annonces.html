<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <title>Document</title>
</head>
<body>
    <header>
        <img src="../resources/cpu.png" alt="Logo">
        <div class="hamburger">
            <i class="fas fa-bars"></i>
            <i class="fas fa-times"></i>
        </div>
        <ul>
            <li><a href="../index.html" class="hover">Accueil</a></li>
            <li><a href="" class="active">Annonces</a></li>
            <li><a href="../add listing form/add.html" class="hover"><i class="fa-solid fa-circle-plus"></i> Publiez une annonce</a></li>
        </ul>
    </header>
    <div class="main">
        <section class="filter">
            <form method="GET" action="get_last_listing.php" class="container">
                <!-- Region -->
                <label for="options">RÃ©gion</label>
                <select id="options" name="options" >
                    <option value="">Choisir votre gouvernorat</option>
                    <option value="Ariana">Ariana</option>
                    <option value="Beja">Beja</option>
                    <option value="Ben Arous">Ben Arous</option>
                    <option value="Bizerte">Bizerte</option>
                    <option value="Gabes">Gabes</option>
                    <option value="Gafsa">Gafsa</option>
                    <option value="Jendouba">Jendouba</option>
                    <option value="Kairouan">Kairouan</option>
                    <option value="Kasserine">Kasserine</option>
                    <option value="Kebili">Kebili</option>
                    <option value="Kef">Kef</option>
                    <option value="Mahdia">Mahdia</option>
                    <option value="Manouba">Manouba</option>
                    <option value="Medenine">Medenine</option>
                    <option value="Monastir">Monastir</option>
                    <option value="Nabeul">Nabeul</option>
                    <option value="Sfax">Sfax</option>
                    <option value="Sidi Bouzid">Sidi Bouzid</option>
                    <option value="Siliana">Siliana</option>
                    <option value="Sousse">Sousse</option>
                    <option value="Tataouine">Tataouine</option>
                    <option value="Tozeur">Tozeur</option>
                    <option value="Tunis">Tunis</option>
                    <option value="Zaghouan">Zaghouan</option>
                </select>

                <!-- Type -->
                <label for="type">Type</label>
                <input type="text" name="type" id="type" placeholder="choisissez votre type">
                <!-- Budget -->
                <label for="budget">Budget (TND)</label>
                <input type="number" id="budget" name="budget" placeholder="Entrez votre budget" min="0" >
                <button type="submit">Filtrer</button>
            </form>
        </section>
        
        <section class="listings" id="listings">
            <form action="get_last_listing.php">
                <div id="lastListing"></div>
            </form>
        </section>
    </div>

    <script src="script.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Fetch all listings when the page loads
            fetchListings();

            // filter
            const filterForm = document.querySelector("form.container");
            filterForm.addEventListener("submit", function(e) {
                e.preventDefault(); // Prevent page reload
                let formData = new FormData(filterForm); // Get form data
                fetchListings(formData); // Fetch filtered listings
            });

            // delete buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-btn')) {
                    let listingId = e.target.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this listing?')) {
                        deleteListing(listingId);
                    }
                }
            });
        });

        function fetchListings(formData = null) {
            let xhr = new XMLHttpRequest();
            let url = 'get_last_listing.php';

            // If there are filters, append them as query parameters
            if (formData) {
                let params = new URLSearchParams(formData).toString();
                url += '?' + params;
            }

            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    document.getElementById("lastListing").innerHTML = xhr.responseText;
                }
            };
            xhr.send();
        }

        function deleteListing(listingId) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', 'delete_listing.php', true); // Create 'delete_listing.php' to handle deletion
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText === 'Listing deleted successfully') {
                        document.querySelector('.annonce[data-id="' + listingId + '"]').remove();
                    } else {
                        alert('Failed to delete the listing: ' + xhr.responseText);
                    }
                }
            };
            xhr.send('id=' + listingId);
        }


    </script>
    
</body>
</html>
